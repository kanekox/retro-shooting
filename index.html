<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>かわいい Canvas シューティング 完全版</title>
<style>
  body { margin: 0; overflow: hidden; background: black; }
  canvas { display: block; margin: 0 auto; background: #000; touch-action: none; }
  #controls {
    position: fixed; bottom: 10px; left: 0; right: 0;
    display: flex; justify-content: space-around; pointer-events: auto;
  }
  .btn {
    background: rgba(255,255,255,0.2); border-radius: 50%;
    width: 60px; height: 60px; text-align: center; line-height: 60px;
    color: white; font-size: 30px; user-select: none;
  }
</style>
</head>
<body>
<canvas id="gameCanvas" width="480" height="640"></canvas>
<div id="controls">
  <div class="btn" id="left">←</div>
  <div class="btn" id="shoot">★</div>
  <div class="btn" id="right">→</div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const keys = { left:false, right:false, space:false };

let player, bullets, enemies, enemyBullets, explosions;
let score, lives, gameOver, frame;
let stars = [];
let bgm, audioCtx, gain;
let level;
let levelUpFrame = 0;

// --- Audio Synth（WebAudioで擬似BGM＆効果音）---
function playSound(freq, duration, type='sine', vol=0.1){
  if(!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  g.gain.value = vol;
  osc.connect(g);
  g.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}

// --- 初期化 ---
function init(){
  player = { x:220, y:580, w:40, h:20, speed:5, blink:0 };
  bullets = [];
  enemies = [];
  enemyBullets = [];
  explosions = [];
  score = 0;
  lives = 3;
  gameOver = false;
  frame = 0;
  level = 1;
  levelUpFrame = 0;

  // 星
  stars = [];
  for(let i=0; i<100; i++){
    stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, size:Math.random()*2, speed:1+Math.random()*2});
  }
}

// --- 入力 ---
document.addEventListener('keydown', e=>{
  if(e.code==='ArrowLeft') keys.left=true;
  if(e.code==='ArrowRight') keys.right=true;
  if(e.code==='Space') keys.space=true;
  if(e.code==='Enter' && gameOver) init();
});
document.addEventListener('keyup', e=>{
  if(e.code==='ArrowLeft') keys.left=false;
  if(e.code==='ArrowRight') keys.right=false;
  if(e.code==='Space') keys.space=false;
});

// --- スマホ ---
['left','right','shoot'].forEach(id=>{
  const btn=document.getElementById(id);
  btn.addEventListener('touchstart',()=>keys[id==='left'?'left':id==='right'?'right':'space']=true);
  btn.addEventListener('touchend',()=>keys[id==='left'?'left':id==='right'?'right':'space']=false);
});

// --- 敵生成 ---
function spawnEnemy(){
  // enemies.push({x:Math.random()*440, y:-20, w:30, h:20, speed:2+Math.random()*2, type:Math.random()<0.5?'normal':'shooter'});
  const speed = 2 + Math.random() * (2 + level * 0.5);
  const type = Math.random() < 0.5 ? 'normal' : 'shooter';
  enemies.push({x:Math.random()*440, y:-20, w:30, h:20, speed, type});
}

// --- 星更新 ---
function updateStars(){
  for(let s of stars){
    s.y+=s.speed;
    if(s.y>canvas.height){
      s.y=0; s.x=Math.random()*canvas.width;
    }
  }
}

// --- 爆発生成 ---
function addExplosion(x,y,color='yellow'){
  explosions.push({x,y,r:0,max:15,color});
  playSound(200,0.1,'triangle',0.15);
}

// --- 更新 ---
function update(){
  if(gameOver) return;
  frame++;
  updateStars();

  if(keys.left) player.x-=player.speed;
  if(keys.right) player.x+=player.speed;
  player.x=Math.max(0,Math.min(canvas.width-player.w,player.x));

  // 弾
  if(keys.space && frame%10===0){
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:10,speed:7});
    playSound(880,0.05,'sawtooth',0.1);
  }
  bullets.forEach(b=>b.y-=b.speed);
  bullets=bullets.filter(b=>b.y>-b.h);

  // 敵
  // !!if(frame%60===0) spawnEnemy();
  if (frame % Math.max(20, 60 - level * 5) === 0) spawnEnemy();
  enemies.forEach(e=>{
    e.y+=e.speed;
    if(e.type==='shooter' && frame%90===0)
      enemyBullets.push({x:e.x+e.w/2-2,y:e.y+e.h,w:4,h:10,speed:4});
  });
  enemies=enemies.filter(e=>e.y<canvas.height);

  enemyBullets.forEach(b=>b.y+=b.speed);
  enemyBullets=enemyBullets.filter(b=>b.y<canvas.height);

  // 衝突
  for(let b of bullets){
    for(let e of enemies){
      if(b.x<e.x+e.w && b.x+b.w>e.x && b.y<e.y+e.h && b.y+b.h>e.y){
        e.dead=b.dead=true; score+=10;
        addExplosion(e.x+e.w/2,e.y+e.h/2,'orange');
      }
    }
  }
  bullets=bullets.filter(b=>!b.dead);
  enemies=enemies.filter(e=>!e.dead);

  // 当たり判定
  [...enemies,...enemyBullets].forEach(obj=>{
    if(player.x<obj.x+obj.w && player.x+player.w>obj.x &&
       player.y<obj.y+obj.h && player.y+player.h>obj.y){
      obj.dead=true;
      lives--;
      player.blink=30;
      addExplosion(player.x+player.w/2,player.y+player.h/2,'pink');
      playSound(120,0.1,'square',0.2);
      if(lives<=0) gameOver=true;
    }
  });
  enemyBullets=enemyBullets.filter(b=>!b.dead);

  // 爆発
  explosions.forEach(ex=>ex.r+=1.5);
  explosions=explosions.filter(ex=>ex.r<ex.max);

  if(player.blink>0) player.blink--;

  if (score >= level * 100) {
   nextLevel();
  }
}

// --- レベルアップ処理 ---
function nextLevel() {
  level++;
  levelUpFrame = 120; // 2秒間表示
  playSound(660, 0.2, 'square', 0.15);
}

// --- 描画 ---
function draw(){
  ctx.fillStyle='black';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='white';
  for(let s of stars) ctx.fillRect(s.x,s.y,s.size,s.size);

  // プレイヤー（ハート型）
  if(player.blink%4<2){
    ctx.fillStyle='pink';
    ctx.beginPath();
    const {x,y}=player;
    ctx.moveTo(x+player.w/2,y+player.h);
    ctx.arc(x+player.w*0.3,y+player.h*0.5,player.w*0.2,Math.PI,0);
    ctx.arc(x+player.w*0.7,y+player.h*0.5,player.w*0.2,Math.PI,0);
    ctx.closePath(); ctx.fill();
  }

  // 弾
  ctx.fillStyle='yellow';
  bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

  // 敵（小さなUFO）
  enemies.forEach(e=>{
    ctx.fillStyle=e.type==='normal'?'red':'orange';
    ctx.beginPath();
    ctx.ellipse(e.x+e.w/2,e.y+e.h/2,e.w/2,e.h/2,0,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle='white';
    ctx.fillRect(e.x+e.w/4,e.y+e.h/4,e.w/2,2);
  });

  // 敵弾
  ctx.fillStyle='cyan';
  enemyBullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

  // 爆発
  for(let ex of explosions){
    const grad=ctx.createRadialGradient(ex.x,ex.y,0,ex.x,ex.y,ex.r);
    grad.addColorStop(0,'white');
    grad.addColorStop(1,ex.color);
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.arc(ex.x,ex.y,ex.r,0,Math.PI*2);
    ctx.fill();
  }

  // スコア
  ctx.fillStyle='white';
  ctx.font='20px sans-serif';
  ctx.fillText('SCORE: '+score,10,30);

  // 残機
  for(let i=0;i<lives;i++){
    ctx.fillStyle='pink';
    ctx.beginPath();
    const x=400+i*25, y=25;
    ctx.arc(x-5,y,7,0,Math.PI,false);
    ctx.arc(x+5,y,7,0,Math.PI,false);
    ctx.lineTo(x,y+12);
    ctx.closePath(); ctx.fill();
  }

  if (levelUpFrame > 0) {
    ctx.fillStyle='white';
    ctx.font='30px sans-serif';
    ctx.fillText('LEVEL ' + level, 180, 320);
    levelUpFrame--;
  }

  if(gameOver){
    ctx.fillStyle='white';
    ctx.font='40px sans-serif';
    ctx.fillText('GAME OVER',120,300);
    ctx.font='20px sans-serif';
    ctx.fillText('Press ENTER to Restart',130,340);
  }
}

// --- メインループ ---
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}

// --- Audio 初期化 ---
window.addEventListener('click', ()=>{
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
},{once:true});

init();
loop();
</script>
</body>
</html>
