<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Canvas ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆèƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä»˜ãï¼‰</title>
<style>
  body { margin: 0; overflow: hidden; background: black; }
  canvas { display: block; margin: 0 auto; background: #000; touch-action: none; }
  #controls {
    position: fixed; bottom: 10px; left: 0; right: 0;
    display: flex; justify-content: space-around; pointer-events: auto;
  }
  .btn {
    background: rgba(255,255,255,0.2); border-radius: 50%;
    width: 60px; height: 60px; text-align: center; line-height: 60px;
    color: white; font-size: 30px; user-select: none;
  }
</style>
</head>
<body>
<canvas id="gameCanvas" width="480" height="640"></canvas>

<div id="controls">
  <div class="btn" id="left">â†</div>
  <div class="btn" id="shoot">â˜…</div>
  <div class="btn" id="right">â†’</div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const keys = { left:false, right:false, space:false };

let player, bullets, enemies, enemyBullets, explosions;
let score, lives, gameOver, frame;
let stars = [];

function init(){
  player = { x: 220, y: 580, w: 40, h: 20, speed: 5 };
  bullets = [];
  enemies = [];
  enemyBullets = [];
  explosions = [];
  score = 0;
  lives = 3;
  gameOver = false;
  frame = 0;

  // æ˜Ÿã®åˆæœŸåŒ–
  stars = [];
  for(let i=0; i<100; i++){
    stars.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height,
      size: Math.random()*2,
      speed: 1 + Math.random()*2
    });
  }
}
init();

document.addEventListener('keydown', e => {
  if(e.code === 'ArrowLeft') keys.left = true;
  if(e.code === 'ArrowRight') keys.right = true;
  if(e.code === 'Space') keys.space = true;
  if(gameOver && e.code === 'Enter') init();
});
document.addEventListener('keyup', e => {
  if(e.code === 'ArrowLeft') keys.left = false;
  if(e.code === 'ArrowRight') keys.right = false;
  if(e.code === 'Space') keys.space = false;
});

// --- ã‚¹ãƒãƒ›ãƒœã‚¿ãƒ³ ---
const btnLeft = document.getElementById('left');
const btnRight = document.getElementById('right');
const btnShoot = document.getElementById('shoot');

btnLeft.addEventListener('touchstart', ()=>keys.left=true);
btnLeft.addEventListener('touchend', ()=>keys.left=false);
btnRight.addEventListener('touchstart', ()=>keys.right=true);
btnRight.addEventListener('touchend', ()=>keys.right=false);
btnShoot.addEventListener('touchstart', ()=>keys.space=true);
btnShoot.addEventListener('touchend', ()=>keys.space=false);

// --- æ•µç”Ÿæˆ ---
function spawnEnemy(){
  const type = Math.random()<0.5 ? 'normal' : 'shooter';
  enemies.push({ x:Math.random()*440, y:-20, w:40, h:20, speed:2+Math.random()*1.5, type });
}

// --- æ˜Ÿã®æ›´æ–° ---
function updateStars(){
  for(let s of stars){
    s.y += s.speed;
    if(s.y > canvas.height){
      s.y = 0;
      s.x = Math.random()*canvas.width;
      s.size = Math.random()*2;
    }
  }
}

// --- ãƒ¡ã‚¤ãƒ³æ›´æ–° ---
function update(){
  if(gameOver) return;
  frame++;

  updateStars();

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•
  if(keys.left) player.x -= player.speed;
  if(keys.right) player.x += player.speed;
  player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));

  // å¼¾ç™ºå°„
  if(keys.space && frame % 10 === 0){
    bullets.push({ x: player.x + player.w/2 - 2, y: player.y, w: 4, h: 10, speed: 7 });
  }

  // å¼¾æ›´æ–°
  bullets.forEach(b => b.y -= b.speed);
  bullets = bullets.filter(b => b.y > -b.h);

  // æ•µç”Ÿæˆ
  if(frame % 60 === 0) spawnEnemy();

  // æ•µç§»å‹•
  enemies.forEach(e => {
    e.y += e.speed;
    if(e.type === 'shooter' && frame % 90 === 0){
      enemyBullets.push({ x:e.x+e.w/2-2, y:e.y+e.h, w:4, h:10, speed:4 });
    }
  });
  enemies = enemies.filter(e => e.y < canvas.height);

  // æ•µå¼¾
  enemyBullets.forEach(b => b.y += b.speed);
  enemyBullets = enemyBullets.filter(b => b.y < canvas.height);

  // è¡çªåˆ¤å®š
  for(let b of bullets){
    for(let e of enemies){
      if(b.x < e.x+e.w && b.x+b.w > e.x && b.y < e.y+e.h && b.y+b.h > e.y){
        e.dead = true; b.dead = true; score += 10;
        // ğŸ’¥ çˆ†ç™ºè¿½åŠ 
        explosions.push({
          x: e.x + e.w/2,
          y: e.y + e.h/2,
          r: 5,           // åˆæœŸåŠå¾„
          maxR: 25,       // æœ€å¤§åŠå¾„
          alpha: 1.0,     // ä¸é€æ˜åº¦
        });
      }
    }
  }
  bullets = bullets.filter(b => !b.dead);
  enemies = enemies.filter(e => !e.dead);

  // æ•µãƒ»æ•µå¼¾ã¨ã®å½“ãŸã‚Šåˆ¤å®š
  [...enemies, ...enemyBullets].forEach(obj => {
    if(player.x < obj.x+obj.w && player.x+player.w > obj.x &&
       player.y < obj.y+obj.h && player.y+player.h > obj.y){
      obj.dead = true;
      lives--;
      if(lives <= 0) gameOver = true;
    }
  });
  enemyBullets = enemyBullets.filter(b => !b.dead);

  // --- çˆ†ç™ºæ›´æ–° ---
  explosions.forEach(ex => {
    ex.r += 1.5;       // åŠå¾„æ‹¡å¤§
    ex.alpha -= 0.05;  // å¾ã€…ã«é€æ˜ã«
  });
  explosions = explosions.filter(ex => ex.alpha > 0);
}

// --- æç”» ---
function draw(){
  // èƒŒæ™¯ï¼ˆæ˜Ÿç©ºï¼‰
  ctx.fillStyle = 'black';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = 'white';
  for(let s of stars){
    ctx.fillRect(s.x, s.y, s.size, s.size);
  }

  // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆâ–³ã£ã½ã„å®‡å®™èˆ¹ï¼‰---
  const flicker = Math.floor(frame / 5) % 2;  // 5ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«ON/OFFåˆ‡æ›¿
  ctx.fillStyle = flicker ? '#8ef' : '#4af';  // è‰²ã‚’äº¤äº’ã«
  ctx.beginPath();
  ctx.moveTo(player.x + player.w/2, player.y);
  ctx.lineTo(player.x, player.y + player.h);
  ctx.lineTo(player.x + player.w, player.y + player.h);
  ctx.closePath();
  ctx.fill();

  // --- ã‚¹ãƒ©ã‚¹ã‚¿ãƒ¼ã®ç‚ï¼ˆã‚ªãƒã‚±ï¼‰---
  ctx.fillStyle = flicker ? 'orange' : 'yellow';
  ctx.beginPath();
  ctx.moveTo(player.x + player.w/2, player.y + player.h);
  ctx.lineTo(player.x + player.w/2 - 4, player.y + player.h + 10);
  ctx.lineTo(player.x + player.w/2 + 4, player.y + player.h + 10);
  ctx.closePath();
  ctx.fill();

  // --- å¼¾ ---
  ctx.fillStyle = 'yellow';
  bullets.forEach(b => ctx.fillRect(b.x, b.y, b.w, b.h));

  // --- æ•µã‚­ãƒ£ãƒ©ï¼ˆã‚¿ã‚¤ãƒ—åˆ¥ã«å½¢çŠ¶ã‚’å¤‰ãˆã‚‹ï¼‰---
  enemies.forEach(e => {
    const flicker = Math.floor((frame + e.x) / 10) % 2; // æ•µã”ã¨ã«ãšã‚‰ã™
    if(e.type === 'normal'){
      ctx.fillStyle = flicker ? '#f44' : '#a00';
      // ã²ã—å½¢
      ctx.beginPath();
      ctx.moveTo(e.x + e.w/2, e.y);
      ctx.lineTo(e.x + e.w, e.y + e.h/2);
      ctx.lineTo(e.x + e.w/2, e.y + e.h);
      ctx.lineTo(e.x, e.y + e.h/2);
      ctx.closePath();
      ctx.fill();
    } else {
      ctx.fillStyle = flicker ? '#ff9933' : '#cc6600';
      // Uå­—å‹
      ctx.beginPath();
      ctx.moveTo(e.x, e.y);
      ctx.lineTo(e.x + e.w, e.y);
      ctx.lineTo(e.x + e.w, e.y + e.h*0.7);
      ctx.lineTo(e.x + e.w*0.7, e.y + e.h);
      ctx.lineTo(e.x + e.w*0.3, e.y + e.h);
      ctx.lineTo(e.x, e.y + e.h*0.7);
      ctx.closePath();
      ctx.fill();
    }
  });

  // --- æ•µå¼¾ ---
  ctx.fillStyle = 'cyan';
  enemyBullets.forEach(b => ctx.fillRect(b.x, b.y, b.w, b.h));

  // --- çˆ†ç™ºæç”» ---
  explosions.forEach(ex => {
    const gradient = ctx.createRadialGradient(ex.x, ex.y, 0, ex.x, ex.y, ex.r);
    gradient.addColorStop(0, `rgba(255,255,255,${ex.alpha})`);
    gradient.addColorStop(0.3, `rgba(255,200,0,${ex.alpha})`);
    gradient.addColorStop(0.6, `rgba(255,80,0,${ex.alpha * 0.8})`);
    gradient.addColorStop(1, `rgba(0,0,0,0)`);

    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(ex.x, ex.y, ex.r, 0, Math.PI * 2);
    ctx.fill();
  });

  // --- ã‚¹ã‚³ã‚¢è¡¨ç¤º ---
  ctx.fillStyle = 'white';
  ctx.font = '20px sans-serif';
  ctx.fillText('SCORE: ' + score, 10, 30);

  // --- æ®‹æ©Ÿè¡¨ç¤ºï¼ˆãƒãƒ¼ãƒˆï¼‰---
  for(let i=0; i<lives; i++){
    ctx.fillStyle = 'pink';
    ctx.beginPath();
    const x = 400 + i*25;
    const y = 25;
    ctx.arc(x-5, y, 7, 0, Math.PI, false);
    ctx.arc(x+5, y, 7, 0, Math.PI, false);
    ctx.lineTo(x, y+12);
    ctx.closePath();
    ctx.fill();
  }

  // --- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¡¨ç¤º ---
  if(gameOver){
    ctx.fillStyle = 'white';
    ctx.font = '40px sans-serif';
    ctx.fillText('GAME OVER', 120, 300);
    ctx.font = '20px sans-serif';
    ctx.fillText('Press ENTER to Restart', 130, 340);
  }
}

// --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
